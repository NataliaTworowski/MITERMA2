{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <title>{{ title }}</title>
    {% include 'partials/head.html' %}
</head>
<body class="min-h-screen bg-[#f8fafc] flex flex-col">
    <!-- Navbar cliente -->
    <div class="hidden md:block fixed top-0 left-0 right-0 z-40">
        {% include 'partials/navbar_usuario2.html' %}
    </div>

    <main class="flex-1 pt-20 md:pt-24 px-4 md:px-8 lg:px-16 mb-16 transition-all duration-300">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Mi Perfil</h1>

            <div class="grid gap-6 lg:grid-cols-3">
                <!-- Información Personal - Ocupa 2 columnas -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Información Personal</h2>
                        <button onclick="toggleEditMode()" id="edit-btn" class="inline-flex items-center px-3 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors duration-200 text-sm">
                            <i class="fas fa-edit mr-1"></i>
                            Editar
                        </button>
                    </div>
                    
                    <!-- Formulario de información personal -->
                    <form id="perfil-form" method="POST" action="{% url 'usuarios:actualizar_perfil' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="perfil">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Nombre completo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Nombre completo</label>
                                <div id="nombre-display" class="text-gray-900 py-2 font-medium">{{ usuario.nombre }} {{ usuario.apellido }}</div>
                                <div id="nombre-edit" class="hidden grid grid-cols-2 gap-3">
                                    <input type="text" name="nombre" value="{{ usuario.nombre }}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                           placeholder="Nombre" required>
                                    <input type="text" name="apellido" value="{{ usuario.apellido }}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                           placeholder="Apellido" required>
                                </div>
                            </div>

                            <!-- Número de celular -->
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Número de celular</label>
                                <div id="telefono-display" class="text-gray-900 py-2 font-medium">{{ usuario.telefono|default:"No especificado" }}</div>
                                <div id="telefono-edit" class="hidden">
                                    <input type="tel" name="telefono" value="{{ usuario.telefono }}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                           placeholder="+56 9 XXXX XXXX">
                                </div>
                            </div>

                            <!-- Correo electrónico -->
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Correo electrónico</label>
                                <div class="text-gray-900 py-2 font-medium flex items-center">
                                    {{ usuario.email }}
                                    <i class="fas fa-lock ml-2 text-gray-400 text-sm" title="No se puede modificar"></i>
                                </div>
                            </div>

                            <!-- Miembro desde -->
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Miembro desde</label>
                                <div class="text-gray-900 py-2 font-medium">{{ usuario.date_joined|date:"d/m/Y" }}</div>
                            </div>
                        </div>

                        <!-- Botones de acción (solo visible en modo edición) -->
                        <div id="form-actions" class="hidden mt-6 flex gap-3">
                            <button type="submit" class="inline-flex items-center px-6 py-3 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors duration-200 font-medium">
                                <i class="fas fa-save mr-2"></i>
                                Guardar cambios
                            </button>
                            <button type="button" onclick="cancelEdit()" class="inline-flex items-center px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 font-medium">
                                <i class="fas fa-times mr-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Acciones Rápidas - Ocupa 1 columna -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Acciones Rápidas</h2>
                    <div class="space-y-4">
                        <a href="{% url 'usuarios:mis_entradas' %}" class="flex items-center p-4 rounded-lg border border-gray-200 hover:border-cyan-300 hover:bg-cyan-50 transition-all duration-200 group">
                            <div class="flex items-center justify-center w-10 h-10 bg-cyan-100 rounded-lg mr-4 group-hover:bg-cyan-200 transition-colors">
                                <i class="fas fa-ticket-alt text-cyan-600"></i>
                            </div>
                            <span class="font-medium text-gray-800 group-hover:text-cyan-700">Ver mis entradas</span>
                        </a>
                        
                        <a href="{% url 'usuarios:favoritos' %}" class="flex items-center p-4 rounded-lg border border-gray-200 hover:border-cyan-300 hover:bg-cyan-50 transition-all duration-200 group">
                            <div class="flex items-center justify-center w-10 h-10 bg-cyan-100 rounded-lg mr-4 group-hover:bg-cyan-200 transition-colors">
                                <i class="fas fa-heart text-cyan-600"></i>
                            </div>
                            <span class="font-medium text-gray-800 group-hover:text-cyan-700">Mis favoritos</span>
                        </a>
                        
                        <a href="{% url 'core:mostrar_termas' %}" class="flex items-center p-4 rounded-lg border border-gray-200 hover:border-cyan-300 hover:bg-cyan-50 transition-all duration-200 group">
                            <div class="flex items-center justify-center w-10 h-10 bg-cyan-100 rounded-lg mr-4 group-hover:bg-cyan-200 transition-colors">
                                <i class="fas fa-search text-cyan-600"></i>
                            </div>
                            <span class="font-medium text-gray-800 group-hover:text-cyan-700">Explorar termas</span>
                        </a>
                    </div>
                </div>

                <!-- Cambio de Contraseña - Ancho completo -->
                <div class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Cambiar Contraseña</h2>
                    
                    <form id="password-form" method="POST" action="{% url 'usuarios:cambiar_contrasena' %}">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Contraseña actual</label>
                                <input type="password" name="current_password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                       placeholder="Ingresa tu contraseña actual"
                                       required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Nueva contraseña</label>
                                <input type="password" name="new_password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                       placeholder="Ingresa tu nueva contraseña"
                                       required minlength="8">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-2">Confirmar nueva contraseña</label>
                                <input type="password" name="confirm_password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                       placeholder="Confirma tu nueva contraseña"
                                       required minlength="8">
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button type="submit" class="inline-flex items-center px-6 py-3 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors duration-200 font-medium">
                                <i class="fas fa-key mr-2"></i>
                                Cambiar contraseña
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    {% include 'partials/footer.html' %}

    <!-- Notificaciones de mensajes -->
    {% if messages %}
        <div id="messages-container" class="fixed top-20 right-4 z-50 space-y-2">
            {% for message in messages %}
                <div class="p-4 rounded-lg shadow-lg max-w-sm {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% else %}bg-red-100 text-red-800 border border-red-200{% endif %}">
                    <div class="flex items-center">
                        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} mr-2"></i>
                        <span>{{ message.message }}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <script>
        let editMode = false;

        function toggleEditMode() {
            editMode = !editMode;
            const editBtn = document.getElementById('edit-btn');
            const formActions = document.getElementById('form-actions');
            
            // Elementos de visualización
            const nombreDisplay = document.getElementById('nombre-display');
            const telefonoDisplay = document.getElementById('telefono-display');
            
            // Elementos de edición
            const nombreEdit = document.getElementById('nombre-edit');
            const telefonoEdit = document.getElementById('telefono-edit');

            if (editMode) {
                // Modo edición
                editBtn.innerHTML = '<i class="fas fa-times mr-1"></i> Cancelar';
                editBtn.className = 'inline-flex items-center px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 text-sm';
                
                nombreDisplay.classList.add('hidden');
                telefonoDisplay.classList.add('hidden');
                nombreEdit.classList.remove('hidden');
                telefonoEdit.classList.remove('hidden');
                formActions.classList.remove('hidden');
            } else {
                // Modo visualización
                cancelEdit();
            }
        }

        function cancelEdit() {
            editMode = false;
            const editBtn = document.getElementById('edit-btn');
            const formActions = document.getElementById('form-actions');
            
            // Elementos de visualización
            const nombreDisplay = document.getElementById('nombre-display');
            const telefonoDisplay = document.getElementById('telefono-display');
            
            // Elementos de edición
            const nombreEdit = document.getElementById('nombre-edit');
            const telefonoEdit = document.getElementById('telefono-edit');

            editBtn.innerHTML = '<i class="fas fa-edit mr-1"></i> Editar';
            editBtn.className = 'inline-flex items-center px-3 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors duration-200 text-sm';
            
            nombreDisplay.classList.remove('hidden');
            telefonoDisplay.classList.remove('hidden');
            nombreEdit.classList.add('hidden');
            telefonoEdit.classList.add('hidden');
            formActions.classList.add('hidden');

            // Django maneja la actualización con update_session_auth_hash
            // No es necesario updateDisplayValues() aquí
        }

        // Validación de contraseñas
        document.getElementById('password-form').addEventListener('submit', function(e) {
            const newPassword = document.querySelector('input[name="new_password"]').value;
            const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('Las contraseñas no coinciden. Por favor, verifica e intenta nuevamente.');
                return false;
            }
            
            if (newPassword.length < 8) {
                e.preventDefault();
                alert('La nueva contraseña debe tener al menos 8 caracteres.');
                return false;
            }
        });

        // Auto-ocultar notificaciones después de 5 segundos
        document.addEventListener('DOMContentLoaded', function() {
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                setTimeout(() => {
                    messagesContainer.style.opacity = '0';
                    setTimeout(() => {
                        messagesContainer.remove();
                    }, 300);
                }, 5000);
            }
        });
    </script>
</body>
</html>
