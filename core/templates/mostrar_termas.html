{% load static %}
{% load humanize %}
{% load precio_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termas Asociadas - MiTerma</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="{% static 'core/css/core.css' %}">
</head>
<body class="flex flex-col min-h-screen font-sans bg-white termas-page">
    <!-- Navbar -->
    {% if user.is_authenticated %}
        <div class="fixed top-0 left-0 right-0 z-50">
            {% include 'partials/navbar_usuario2.html' with active_page='termas' %}
        </div>
    {% else %}
        <div class="fixed top-0 left-0 right-0 z-50">
            {% include 'partials/navbar.html' with navbar_mode='termas_only' %}
        </div>
    {% endif %}

    <!-- Modales -->
    {% include 'partials/login_modal.html' %}
    {% include 'partials/register_modal.html' %}
    {% include 'partials/usuario_inactivo.html' %}

    <!-- Contenido Principal -->
    <main class="flex-grow container mx-auto px-4 pt-20 pb-8">
        <h1 class="text-4xl font-bold mb-6 text-center">Nuestras Termas Asociadas</h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-8 text-center">
            Explora una selección de las termas más destacadas de Chile
        </p>

        <!-- Formulario de búsqueda -->
        <div class="bg-white rounded-2xl p-8 mb-8 shadow flex flex-col gap-6">
            <div>
                <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-1">Encuentra tu experiencia termal ideal</h2>
                <p class="text-base md:text-lg text-gray-500">Busca y filtra para descubrir las mejores termas de Chile.</p>
            </div>
            
            <form action="{% url 'core:mostrar_termas' %}" method="GET" class="flex flex-col gap-4">
                <!-- Barra de búsqueda principal -->
                <div class="flex flex-col md:flex-row md:items-center gap-4 w-full">
                    <div class="flex-1 relative">
                        <input type="text" 
                               name="nombre" 
                               placeholder="Buscar por nombre..." 
                               value="{{ request.GET.nombre|default:'' }}"
                               onkeyup="if(event.key==='Enter') this.form.submit()"
                               class="w-full pl-12 pr-4 py-3 rounded-lg border border-gray-200 bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 placeholder-gray-400 text-base shadow-sm">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex items-center gap-2 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow transition whitespace-nowrap">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M3 6h18M3 12h18M3 18h18"/>
                            </svg>
                            Aplicar Filtros
                        </button>
                        {% if request.GET.nombre or request.GET.region or request.GET.comuna or request.GET.precio or request.GET.calificacion %}
                            <a href="{% url 'core:mostrar_termas' %}" class="flex items-center gap-2 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow transition whitespace-nowrap">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Limpiar Filtros
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Filtros -->
                <div class="flex flex-wrap gap-3 mt-2">
                    <!-- Región -->
                    <select name="region" class="px-4 py-2 rounded-full border border-gray-200 bg-gray-100 text-gray-700 text-sm font-medium focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition appearance-none">
                        <option value="">Región</option>
                        <option value="Región de Arica y Parinacota" {% if request.GET.region == 'Región de Arica y Parinacota' %}selected{% endif %}>Región de Arica y Parinacota</option>
                        <option value="Región de Tarapacá" {% if request.GET.region == 'Región de Tarapacá' %}selected{% endif %}>Región de Tarapacá</option>
                        <option value="Región de Antofagasta" {% if request.GET.region == 'Región de Antofagasta' %}selected{% endif %}>Región de Antofagasta</option>
                        <option value="Región de Atacama" {% if request.GET.region == 'Región de Atacama' %}selected{% endif %}>Región de Atacama</option>
                        <option value="Región de Coquimbo" {% if request.GET.region == 'Región de Coquimbo' %}selected{% endif %}>Región de Coquimbo</option>
                        <option value="Región de Valparaíso" {% if request.GET.region == 'Región de Valparaíso' %}selected{% endif %}>Región de Valparaíso</option>
                        <option value="Región Metropolitana" {% if request.GET.region == 'Región Metropolitana' %}selected{% endif %}>Región Metropolitana</option>
                        <option value="Región de O'Higgins" {% if request.GET.region == "Región de O'Higgins" %}selected{% endif %}>Región de O'Higgins</option>
                        <option value="Región del Maule" {% if request.GET.region == 'Región del Maule' %}selected{% endif %}>Región del Maule</option>
                        <option value="Región de Ñuble" {% if request.GET.region == 'Región de Ñuble' %}selected{% endif %}>Región de Ñuble</option>
                        <option value="Región del Biobío" {% if request.GET.region == 'Región del Biobío' %}selected{% endif %}>Región del Biobío</option>
                        <option value="Región de La Araucanía" {% if request.GET.region == 'Región de La Araucanía' %}selected{% endif %}>Región de La Araucanía</option>
                        <option value="Región de Los Ríos" {% if request.GET.region == 'Región de Los Ríos' %}selected{% endif %}>Región de Los Ríos</option>
                        <option value="Región de Los Lagos" {% if request.GET.region == 'Región de Los Lagos' %}selected{% endif %}>Región de Los Lagos</option>
                        <option value="Región de Aysén" {% if request.GET.region == 'Región de Aysén' %}selected{% endif %}>Región de Aysén</option>
                        <option value="Región de Magallanes" {% if request.GET.region == 'Región de Magallanes' %}selected{% endif %}>Región de Magallanes</option>
                    </select>

                    <!-- Comuna -->
                    <select name="comuna" class="px-4 py-2 rounded-full border border-gray-200 bg-gray-100 text-gray-700 text-sm font-medium focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition appearance-none">
                        <option value="">Comuna</option>
                        <option value="Arica" {% if request.GET.comuna == 'Arica' %}selected{% endif %}>Arica</option>
                        <option value="Camarones" {% if request.GET.comuna == 'Camarones' %}selected{% endif %}>Camarones</option>
                        <option value="Putre" {% if request.GET.comuna == 'Putre' %}selected{% endif %}>Putre</option>
                        <option value="General Lagos" {% if request.GET.comuna == 'General Lagos' %}selected{% endif %}>General Lagos</option>
                        <option value="Alto Hospicio" {% if request.GET.comuna == 'Alto Hospicio' %}selected{% endif %}>Alto Hospicio</option>
                        <option value="Iquique" {% if request.GET.comuna == 'Iquique' %}selected{% endif %}>Iquique</option>
                        <option value="Camiña" {% if request.GET.comuna == 'Camiña' %}selected{% endif %}>Camiña</option>
                        <option value="Colchane" {% if request.GET.comuna == 'Colchane' %}selected{% endif %}>Colchane</option>
                        <option value="Huara" {% if request.GET.comuna == 'Huara' %}selected{% endif %}>Huara</option>
                        <option value="Pica" {% if request.GET.comuna == 'Pica' %}selected{% endif %}>Pica</option>
                        <option value="Pozo Almonte" {% if request.GET.comuna == 'Pozo Almonte' %}selected{% endif %}>Pozo Almonte</option>
                        <option value="Antofagasta" {% if request.GET.comuna == 'Antofagasta' %}selected{% endif %}>Antofagasta</option>
                        <option value="Mejillones" {% if request.GET.comuna == 'Mejillones' %}selected{% endif %}>Mejillones</option>
                        <option value="Sierra Gorda" {% if request.GET.comuna == 'Sierra Gorda' %}selected{% endif %}>Sierra Gorda</option>
                        <option value="Taltal" {% if request.GET.comuna == 'Taltal' %}selected{% endif %}>Taltal</option>
                        <option value="Calama" {% if request.GET.comuna == 'Calama' %}selected{% endif %}>Calama</option>
                        <option value="Ollagüe" {% if request.GET.comuna == 'Ollagüe' %}selected{% endif %}>Ollagüe</option>
                        <option value="San Pedro de Atacama" {% if request.GET.comuna == 'San Pedro de Atacama' %}selected{% endif %}>San Pedro de Atacama</option>
                        <option value="María Elena" {% if request.GET.comuna == 'María Elena' %}selected{% endif %}>María Elena</option>
                        <option value="Tocopilla" {% if request.GET.comuna == 'Tocopilla' %}selected{% endif %}>Tocopilla</option>
                        <option value="Caldera" {% if request.GET.comuna == 'Caldera' %}selected{% endif %}>Caldera</option>
                        <option value="Chañaral" {% if request.GET.comuna == 'Chañaral' %}selected{% endif %}>Chañaral</option>
                        <option value="Copiapó" {% if request.GET.comuna == 'Copiapó' %}selected{% endif %}>Copiapó</option>
                        <option value="Diego de Almagro" {% if request.GET.comuna == 'Diego de Almagro' %}selected{% endif %}>Diego de Almagro</option>
                        <option value="Freirina" {% if request.GET.comuna == 'Freirina' %}selected{% endif %}>Freirina</option>
                        <option value="Huasco" {% if request.GET.comuna == 'Huasco' %}selected{% endif %}>Huasco</option>
                        <option value="Tierra Amarilla" {% if request.GET.comuna == 'Tierra Amarilla' %}selected{% endif %}>Tierra Amarilla</option>
                        <option value="Vallenar" {% if request.GET.comuna == 'Vallenar' %}selected{% endif %}>Vallenar</option>
                        <option value="Alto del Carmen" {% if request.GET.comuna == 'Alto del Carmen' %}selected{% endif %}>Alto del Carmen</option>
                        <option value="Andacollo" {% if request.GET.comuna == 'Andacollo' %}selected{% endif %}>Andacollo</option>
                        <option value="Canela" {% if request.GET.comuna == 'Canela' %}selected{% endif %}>Canela</option>
                        <option value="Combarbalá" {% if request.GET.comuna == 'Combarbalá' %}selected{% endif %}>Combarbalá</option>
                        <option value="Coquimbo" {% if request.GET.comuna == 'Coquimbo' %}selected{% endif %}>Coquimbo</option>
                        <option value="Illapel" {% if request.GET.comuna == 'Illapel' %}selected{% endif %}>Illapel</option>
                        <option value="La Higuera" {% if request.GET.comuna == 'La Higuera' %}selected{% endif %}>La Higuera</option>
                        <option value="La Serena" {% if request.GET.comuna == 'La Serena' %}selected{% endif %}>La Serena</option>
                        <option value="Los Vilos" {% if request.GET.comuna == 'Los Vilos' %}selected{% endif %}>Los Vilos</option>
                        <option value="Monte Patria" {% if request.GET.comuna == 'Monte Patria' %}selected{% endif %}>Monte Patria</option>
                        <option value="Ovalle" {% if request.GET.comuna == 'Ovalle' %}selected{% endif %}>Ovalle</option>
                        <option value="Paiguano" {% if request.GET.comuna == 'Paiguano' %}selected{% endif %}>Paiguano</option>
                        <option value="Punitaqui" {% if request.GET.comuna == 'Punitaqui' %}selected{% endif %}>Punitaqui</option>
                        <option value="Río Hurtado" {% if request.GET.comuna == 'Río Hurtado' %}selected{% endif %}>Río Hurtado</option>
                        <option value="Salamanca" {% if request.GET.comuna == 'Salamanca' %}selected{% endif %}>Salamanca</option>
                        <option value="Vicuña" {% if request.GET.comuna == 'Vicuña' %}selected{% endif %}>Vicuña</option>
                        <option value="Pucón" {% if request.GET.comuna == 'Pucón' %}selected{% endif %}>Pucón</option>
                        <option value="Villarrica" {% if request.GET.comuna == 'Villarrica' %}selected{% endif %}>Villarrica</option>
                        <option value="Temuco" {% if request.GET.comuna == 'Temuco' %}selected{% endif %}>Temuco</option>
                        <option value="Puerto Montt" {% if request.GET.comuna == 'Puerto Montt' %}selected{% endif %}>Puerto Montt</option>
                        <option value="Puerto Varas" {% if request.GET.comuna == 'Puerto Varas' %}selected{% endif %}>Puerto Varas</option>
                        <option value="Osorno" {% if request.GET.comuna == 'Osorno' %}selected{% endif %}>Osorno</option>
                        <option value="Valdivia" {% if request.GET.comuna == 'Valdivia' %}selected{% endif %}>Valdivia</option>
                        <option value="Coihaique" {% if request.GET.comuna == 'Coihaique' %}selected{% endif %}>Coihaique</option>
                        <option value="Punta Arenas" {% if request.GET.comuna == 'Punta Arenas' %}selected{% endif %}>Punta Arenas</option>
                    </select>

                    <!-- Precio -->
                    <select name="precio" class="px-4 py-2 rounded-full border border-gray-200 bg-gray-100 text-gray-700 text-sm font-medium focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition appearance-none">
                        <option value="">Precio</option>
                        <option value="1" {% if request.GET.precio == '1' %}selected{% endif %}>Hasta $20.000</option>
                        <option value="2" {% if request.GET.precio == '2' %}selected{% endif %}>$20.000 - $40.000</option>
                        <option value="3" {% if request.GET.precio == '3' %}selected{% endif %}>$40.000 - $60.000</option>
                        <option value="4" {% if request.GET.precio == '4' %}selected{% endif %}>Más de $60.000</option>
                    </select>

                    <!-- Calificación -->
                    <select name="calificacion" class="px-4 py-2 rounded-full border border-gray-200 bg-gray-100 text-gray-700 text-sm font-medium focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition appearance-none">
                        <option value="">Calificación</option>
                        <option value="5" {% if request.GET.calificacion == '5' %}selected{% endif %}>5 estrellas</option>
                        <option value="4" {% if request.GET.calificacion == '4' %}selected{% endif %}>4+ estrellas</option>
                        <option value="3" {% if request.GET.calificacion == '3' %}selected{% endif %}>3+ estrellas</option>
                        <option value="2" {% if request.GET.calificacion == '2' %}selected{% endif %}>2+ estrellas</option>
                        <option value="1" {% if request.GET.calificacion == '1' %}selected{% endif %}>1+ estrellas</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Grid de Termas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for terma in termas %}
                <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 flex flex-col">
                    <!-- Imagen -->
                    <div class="relative h-48 overflow-hidden">
                        {% if terma.imagenes.first %}
                            <img src="{{ terma.imagenes.first.url_imagen }}" alt="{{ terma.nombre_terma }}" class="w-full h-full object-cover">
                        {% else %}
                            <div class="w-full h-full bg-gradient-to-br from-blue-400 to-teal-500 flex items-center justify-center">
                                <svg class="w-20 h-20 text-white opacity-70" fill="currentColor" viewBox="0 0 24 24">
                                    <rect x="6" y="8" width="12" height="8" rx="2" fill="#fff" fill-opacity="0.5"/>
                                    <rect x="9" y="6" width="6" height="4" rx="1" fill="#fff" fill-opacity="0.5"/>
                                    <rect x="11" y="10" width="2" height="2" rx="1" fill="#fff" fill-opacity="0.7"/>
                                </svg>
                            </div>
                        {% endif %}
                    </div>
                    <!-- Contenido -->
                    <div class="p-6 flex-1 flex flex-col">
                        <h3 class="text-xl font-bold text-gray-900 mb-1">{{ terma.nombre_terma }}</h3>
                        <div class="text-base text-gray-500 mb-2">
                            {% if terma.comuna %}
                                {{ terma.comuna.nombre }}, {{ terma.comuna.region.nombre }}
                            {% else %}
                                Ubicación no especificada
                            {% endif %}
                        </div>
                        <!-- Calificación -->
                        <div class="flex items-center gap-1 mb-2">
                            {% if terma.calificacion_promedio %}
                                {% for i in "12345" %}
                                    {% if forloop.counter|add:0 <= terma.calificacion_promedio|add:0 %}
                                        <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                    {% endif %}
                                {% endfor %}
                                <span class="ml-1 text-gray-700 font-medium text-sm">{{ terma.calificacion_promedio|floatformat:1 }}</span>
                            {% else %}
                                <span class="text-gray-400">Sin calificar</span>
                            {% endif %}
                        </div>
                        <!-- Precio -->
                        <div class="text-base font-semibold text-blue-700 mb-3 mt-auto">
                            {% if terma.precio_minimo %}
                                Desde ${{ terma.precio_minimo|formato_precio }} CLP
                            {% else %}
                                Consultar precio
                            {% endif %}
                        </div>
                        <!-- Botón -->
                        <a href="{% url 'termas:vista_terma' terma.id %}"
                           class="block w-full text-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition mt-2">
                            Ver Detalles
                        </a>
                    </div>
                </div>
            {% empty %}
                <div class="col-span-full text-center py-12">
                    <p class="text-gray-600 text-lg">No hay termas disponibles en este momento.</p>
                </div>
            {% endfor %}
        </div>
    </main>

    <!-- Footer -->
    {% include 'partials/footer.html' %}

    <!-- Scripts -->
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/mostrar_termas.js' %}"></script>
    
    <!-- Script para detectar usuario inactivo -->
    <script>
        // Verificar si se debe mostrar el modal de usuario inactivo
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('usuario_inactivo') === '1') {
                // Limpiar el parámetro de la URL sin recargar la página
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + (window.location.search.replace('?usuario_inactivo=1', '').replace('&usuario_inactivo=1', '') || '');
                if (newUrl.endsWith('?')) {
                    newUrl = newUrl.slice(0, -1);
                }
                window.history.replaceState({path: newUrl}, '', newUrl);
                
                // Mostrar el modal de usuario inactivo
                setTimeout(function() {
                    openUsuarioInactivoModal();
                }, 100);
            }
        });
    </script>
</body>
</html>