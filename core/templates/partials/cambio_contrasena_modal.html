{% load static %}

<link rel="stylesheet" href="{% static 'css/cambio_contrasena.css' %}">

<!-- Modal de Cambio de Contrase√±a -->
<div id="resetPasswordModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="resetPasswordModalContent">
        <!-- Header del Modal -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-t-2xl p-6 text-center relative">
            <h2 class="text-2xl font-bold text-white mb-2">üîê Restablecer Contrase√±a</h2>
            <p class="text-blue-100">Cambia tu contrase√±a de forma segura</p>
            <!-- Bot√≥n cerrar -->
            <button onclick="closeResetPasswordModal()" 
                    class="absolute top-4 right-4 text-white hover:text-blue-200 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenido del Modal -->
        <div class="p-6">
            <!-- Paso 1: Solicitar c√≥digo -->
            <div id="step1" class="step-content">
                <form id="requestCodeForm" method="POST" action="{% url 'usuarios:reset_password' %}">
                    {% csrf_token %}
                    <div class="mb-6">
                        <label for="reset_email" class="block text-sm font-medium text-gray-700 mb-2">
                            üìß Email registrado
                        </label>
                        <input type="email" 
                               id="reset_email" 
                               name="email"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors duration-200"
                               placeholder="tu@email.com"
                               required>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-4 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform hover:scale-105 transition-all duration-200">
                        üì® Enviar C√≥digo de Verificaci√≥n
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <button onclick="showStep2()" 
                            class="text-sm text-gray-600 hover:text-gray-700 transition-colors duration-200">
                        ¬øYa tienes un c√≥digo? Clic aqu√≠
                    </button>
                </div>
            </div>
            
            <!-- Paso 2 para verificar el codigo -->
            <div id="step2" class="step-content hidden">
                <form id="resetPasswordForm" method="POST" action="{% url 'usuarios:reset_password_confirm' %}">
                    {% csrf_token %}
                    
                    <!-- Campo para el c√≥digo -->
                    <div class="mb-4">
                        <label for="verification_code" class="block text-sm font-medium text-gray-700 mb-2">
                            üîë C√≥digo de Verificaci√≥n
                        </label>
                        <input type="text" 
                               id="verification_code" 
                               name="codigo"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 text-center text-2xl font-bold letter-spacing-wide"
                               placeholder="123456"
                               maxlength="6"
                               pattern="[0-9]{6}"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Revisa tu email y copia el c√≥digo de 6 d√≠gitos</p>
                    </div>
                    
                    <!-- Nueva contrase√±a -->
                    <div class="mb-4">
                        <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                            üîí Nueva Contrase√±a
                        </label>
                        <div class="relative">
                            <input type="password" 
                                   id="new_password" 
                                   name="new_password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 pr-16"
                                   placeholder="M√≠nimo 8 caracteres"
                                   minlength="8"
                                   required>
                            <button type="button" 
                                    onclick="togglePasswordVisibility('new_password')"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 text-xs font-medium">
                                <span id="new_password_text">Mostrar</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Confirmar contrase√±a -->
                    <div class="mb-6">
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                            üîí Confirmar Contrase√±a
                        </label>
                        <div class="relative">
                            <input type="password" 
                                   id="confirm_password" 
                                   name="confirm_password"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200 pr-16"
                                   placeholder="Repite tu nueva contrase√±a"
                                   minlength="8"
                                   required>
                            <button type="button" 
                                    onclick="togglePasswordVisibility('confirm_password')"
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 text-xs font-medium">
                                <span id="confirm_password_text">Mostrar</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Indicador de fuerza de contrase√±a -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center text-xs text-gray-500 mb-1">
                            <span>Seguridad de la contrase√±a:</span>
                            <span id="password-strength-text">D√©bil</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="password-strength-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-4 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform hover:scale-105 transition-all duration-200">
                        üîê Cambiar Contrase√±a
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <button onclick="showStep1()" 
                            class="text-sm text-gray-600 hover:text-gray-700 transition-colors duration-200">
                        ‚Üê Volver a solicitar c√≥digo
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer con informaci√≥n -->
        <div class="bg-gray-50 rounded-b-2xl p-4 text-center">
            <p class="text-xs text-gray-500">
                üõ°Ô∏è Tu informaci√≥n est√° protegida y segura<br>
                El c√≥digo expira en 15 minutos
            </p>
        </div>
    </div>
</div>

<script>
    // Funciones para manejar el modal de reset de contrase√±a
function openResetPasswordModal() {
    const modal = document.getElementById('resetPasswordModal');
    const modalContent = document.getElementById('resetPasswordModalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // Mostrar paso 1 por defecto
    showStep1();
}

function closeResetPasswordModal() {
    const modal = document.getElementById('resetPasswordModal');
    const modalContent = document.getElementById('resetPasswordModalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        // Limpiar formularios
        document.getElementById('requestCodeForm').reset();
        document.getElementById('resetPasswordForm').reset();
        // Resetear al paso 1
        showStep1();
    }, 300);
}

function showStep1() {
    document.getElementById('step1').classList.remove('hidden');
    document.getElementById('step2').classList.add('hidden');
}

function showStep2() {
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
}

function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const textSpan = document.getElementById(fieldId + '_text');
    
    if (field.getAttribute('type') === 'password') {
        field.setAttribute('type', 'text');
        field.classList.add('password-visible');
        textSpan.textContent = 'Ocultar';
    } else {
        field.setAttribute('type', 'password');
        field.classList.remove('password-visible');
        textSpan.textContent = 'Mostrar';
    }
}

// Interceptar el env√≠o del formulario de solicitud de c√≥digo
document.addEventListener('DOMContentLoaded', function() {
    const requestForm = document.getElementById('requestCodeForm');
    
    if (requestForm) {
        requestForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Evitar recarga de p√°gina
            
            const email = document.getElementById('reset_email').value;
            const submitButton = this.querySelector('button[type="submit"]');
            
            if (!email) {
                alert('Por favor ingresa tu email');
                return;
            }
            
            // Cambiar bot√≥n a estado de carga
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = 'üì® Enviando c√≥digo...';
            
            // Enviar formulario via fetch
            fetch('{% url "usuarios:reset_password" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => response.text())
            .then(data => {
                // Mostrar mensaje de √©xito y cambiar al paso 2
                showSuccessAndGoToStep2(email);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al enviar el c√≥digo. Intenta nuevamente.');
                
                // Restaurar bot√≥n
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            });
        });
    }
    
    // Otras funciones de validaci√≥n...
    setupPasswordValidation();
    setupModalClickOutside();
});

function showSuccessAndGoToStep2(email) {
    // Mostrar mensaje de √©xito en paso 1
    const step1 = document.getElementById('step1');
    step1.innerHTML = `
        <div class="text-center">
            <div class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <div class="flex items-center justify-center mb-2">
                    <svg class="w-8 h-8 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <p class="font-semibold text-lg">¬°C√≥digo enviado!</p>
                </div>
                <p class="text-sm">Revisa tu email: <strong>${email}</strong></p>
                <p class="text-xs text-gray-600 mt-2">El c√≥digo expira en 15 minutos</p>
            </div>
            
            <div class="animate-pulse">
                <p class="text-gray-600 mb-4">Redirigiendo al paso 2...</p>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: 0%; animation: progress 2s ease-out forwards;"></div>
                </div>
            </div>
        </div>
        
        <style>
            @keyframes progress {
                to { width: 100%; }
            }
        </style>
    `;
    
    // Cambiar autom√°ticamente al paso 2 despu√©s de 2 segundos
    setTimeout(() => {
        showStep2();
        
        // Agregar mensaje en el paso 2
        const step2 = document.getElementById('step2');
        const existingAlert = step2.querySelector('.success-alert');
        if (!existingAlert) {
            const successAlert = document.createElement('div');
            successAlert.className = 'success-alert mb-4 p-3 bg-blue-100 border border-blue-400 text-blue-700 rounded-lg text-sm';
            successAlert.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span>C√≥digo enviado a: <strong>${email}</strong></span>
                </div>
            `;
            step2.insertBefore(successAlert, step2.firstChild);
        }
        
        // Enfocar el campo de c√≥digo
        const codeField = document.getElementById('verification_code');
        if (codeField) {
            codeField.focus();
        }
    }, 2000);
}

function setupPasswordValidation() {
    const newPasswordField = document.getElementById('new_password');
    if (newPasswordField) {
        newPasswordField.addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');
            
            let strength = 0;
            let strengthLabel = 'Muy d√©bil';
            let strengthColor = 'bg-red-500';
            
            if (password.length >= 8) strength += 25;
            if (password.match(/[a-z]/)) strength += 25;
            if (password.match(/[A-Z]/)) strength += 25;
            if (password.match(/[0-9]/)) strength += 25;
            
            if (strength >= 75) {
                strengthLabel = 'Fuerte';
                strengthColor = 'bg-green-500';
            } else if (strength >= 50) {
                strengthLabel = 'Media';
                strengthColor = 'bg-yellow-500';
            } else if (strength >= 25) {
                strengthLabel = 'D√©bil';
                strengthColor = 'bg-orange-500';
            }
            
            strengthBar.style.width = strength + '%';
            strengthBar.className = `h-2 rounded-full transition-all duration-300 ${strengthColor}`;
            strengthText.textContent = strengthLabel;
        });
    }

    const confirmPasswordField = document.getElementById('confirm_password');
    if (confirmPasswordField) {
        confirmPasswordField.addEventListener('input', function() {
            const password = document.getElementById('new_password').value;
            const confirm = this.value;
            
            if (confirm && password !== confirm) {
                this.classList.add('border-blue-500');
                this.classList.remove('border-gray-300');
            } else {
                this.classList.remove('border-blue-500');
                this.classList.add('border-gray-300');
            }
        });
    }

    const verificationCodeField = document.getElementById('verification_code');
    if (verificationCodeField) {
        verificationCodeField.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }
}

function setupModalClickOutside() {
    const resetModal = document.getElementById('resetPasswordModal');
    if (resetModal) {
        resetModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeResetPasswordModal();
            }
        });
    }
}
</script>
